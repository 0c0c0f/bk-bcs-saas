<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="{{ settings.SITE_STATIC_URL }}/assets/vue/bk-magic-vue.min.css">
    <title>BCS Console Mgr</title>
    <style type="text/css">
        .console-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #000;
        }

        .bk-tab-section {
            border: none;
        }

        .bk-tab-content {
            background: #000;
            padding: 20px;
        }

        .bk-tab-section {
            padding: 0;
        }

        .close {
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 24px;
            display: inline-block;
            font-style: normal;
            font-size: 12px;
            background: #eee;
            border-radius: 50%;
            overflow: hidden;
            vertical-align: middle;
            margin-left: 10px;
            color: #999;
            cursor: pointer;
            transform: scale(0.9);
        }

        #app .bk-dropdown-menu {
            display: inline-block;
            position: relative;
            position: absolute;
            left: 0;
            top: 42px;
            z-index: 1000;
            background: #fff;
            width: 200px;
        }

        .bk-tab-label-wrapper .bk-tab-label-list .bk-tab-label-item {
            min-width: 200px;
        }

        [v-cloak] {
            display: none;
        }

        .mask {
            width: 100%;
            height: 100%;
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 1;
            opacity: 0;
        }
    </style>
</head>

<body style="background-color: #000;">
    <div id="app">
        <bk-tab addable :active.sync="active" :closable="closable" @add-panel="addPanel" @close-panel="closePanel"
            v-bk-clickoutside="handleClick">
            <bk-tab-panel v-for="(panel, index) in panels" v-bind="panel" :key="index">
                <iframe @click="handleClick" :src="panel.url" class="console-iframe"
                    :style="{width: `${winWidth - 40}px`, height: `${winHeight - 100}px`}"></iframe>
            </bk-tab-panel>
        </bk-tab>
        <div class="mask" v-show="isDropdownShow"></div>
        <div class="bk-dropdown-menu" :style="{left: `${dropdownLeft}px`}" v-cloak v-show="isDropdownShow">
            <div class="bk-dropdown-content right-align is-show" v-cloak>
                <ul class="bk-dropdown-list">
                    <li>
                        <a href="javascript:;" v-cloak @click.stop.prevent="addTerminal(cluster)"
                            v-for="cluster of clusterList">$[cluster.name]</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <script src="{{ settings.SITE_STATIC_URL }}/assets/vue/vue.js"></script>
    <script src="{{ settings.SITE_STATIC_URL }}/assets/vue/bk-magic-vue.min.js"></script>
    <script src="{{ settings.SITE_STATIC_URL }}/assets/jquery.min.js"></script>
    <script type="text/javascript">
        var app = new Vue({
            delimiters: ['$[', ']'],
            el: '#app',
            data: {
                tabIndex: 0,
                panels: [],
                active: 'test',
                winWidth: 1270,
                winHeight: 500,
                projectId: '',
                siteUrl: '',
                dropdownLeft: 0,
                isDropdownShow: false,
                clusterList: []
            },
            computed: {
                closable() {
                    return this.panels.length > 1
                }
            },
            mounted() {
                this.init()
            },
            methods: {
                init() {
                    this.winWidth = $(window).width()
                    this.winHeight = $(window).height()

                    $(window).resize(function () {
                        this.winWidth = $(window).width()
                        this.winHeight = $(window).height()
                        console.log(this.winWidth)

                    })

                    // const params = this.parseUrlQuery()
                    const url = window.location.href
                    const reg = /mgr\/([\w\d]*)\/cluster\/([\w\d-]*)\//
                    const matcher = url.match(reg)

                    if (matcher) {
                        this.projectId = matcher[1]
                        this.watchMessage()

                        const cluster_url = '{{ settings.DEVOPS_BCS_API_URL }}/api/projects/{{ project_id }}/clusters?limit=1000'
                        self = this
                        $.getJSON(cluster_url, function (result) {
                            self.clusterList = result.data.results
                            self.openTab({
                                clusterId: matcher[2]
                            })
                        })
                    }
                },
                handleClick() {
                    this.isDropdownShow = false
                },
                parseUrlQuery() {
                    const obj = {}
                    let keyvalue = []
                    let url = window.location.href
                    let key = ''
                    let value = ''
                    let paraString = url.substring(url.indexOf('?') + 1, url.length).split('&')

                    for (const i in paraString) {
                        keyvalue = paraString[i].split('=')
                        key = keyvalue[0]
                        value = keyvalue[1]
                        obj[key] = value
                    }
                    return obj
                },
                openTab(data) {
                    if (!data.clusterId) return
                    const self = this
                    const clusterId = data.clusterId
                    let clusterName = 'default'
                    const siteUrl = data.siteUrl
                    const url = `{{ settings.DEVOPS_BCS_API_URL }}/web_console/{{ project_id }}/cluster/${clusterId}/`
                    console.log("open tab", url)

                    const tabKeys = self.panels.map(item => {
                        return item.name
                    })

                    this.clusterList.forEach(item => {
                        if (item.cluster_id === clusterId) {
                            clusterName = item.name
                        }
                    })
                    this.tabIndex++
                    self.panels.push({
                        name: clusterId + this.tabIndex,
                        label: clusterName + this.tabIndex,
                        url: url
                    })
                    self.active = clusterId + this.tabIndex
                    this.isDropdownShow = false
                    console.log(self.panels)
                },
                watchMessage() {
                    const self = this
                    window.addEventListener('message', function (event) {
                        self.openTab(event.data)

                    })
                },
                closePanel(index, panel) {
                    this.panels.splice(index, 1)
                    this.isDropdownShow = false
                },
                addPanel() {
                    let left = $('.bk-tab-add-controller').offset().left
                    if ((left + 200) > this.winWidth) {
                        this.dropdownLeft = left - 200
                    } else {
                        this.dropdownLeft = left
                    }

                    this.isDropdownShow = true
                },
                addTerminal(cluster) {
                    console.log('addTerminal')
                    this.openTab({
                        projectId: this.projectId,
                        siteUrl: this.siteUrl,
                        clusterId: cluster.cluster_id,
                        clusterName: cluster.name
                    })
                    this.isDropdownShow = false
                }
            }
        })
    </script>
</body>

</html>